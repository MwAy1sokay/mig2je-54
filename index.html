<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YouTube Audio Jukebox</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:600px;margin:40px auto;text-align:center;}
    #controls{margin-top:20px;}
    #progress{width:100%;}
    #songList{list-style:none;padding:0;margin-top:20px;text-align:left;}
    #songList li{padding:4px 0;border-bottom:1px solid #ddd;}
    #player{width:0;height:0;visibility:hidden;}
  </style>
</head>
<body>
  <h1>YouTube Audio Jukebox</h1>
  <input type="text" id="videoInput" placeholder="Enter YouTube video ID (e.g. dQw4w9WgXcQ)">
  <button id="addBtn">Add & Play</button>

  <div id="controls">
    <button id="playPauseBtn">Pause</button>
    <button id="skipBtn">Skip</button>
    <input type="range" id="progress" min="0" max="100" value="0">
  </div>

  <h2>Previously Played</h2>
  <ul id="songList"></ul>

  <div id="player"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let player;
    let playlist = [];
    let currentIndex = 0;
    let progressTimer;

    function setCookie(name,value,days){
      const expires = new Date(Date.now()+days*864e5).toUTCString();
      document.cookie = name+'='+encodeURIComponent(value)+'; expires='+expires+'; path=/';
    }
    function getCookie(name){
      return document.cookie.split('; ').reduce((r,v)=>{
        const parts = v.split('=');
        return parts[0]===name ? decodeURIComponent(parts[1]) : r
      }, '');
    }

    function savePlaylist(){
      setCookie('playlist', JSON.stringify(playlist), 365);
    }
    function loadPlaylist(){
      const data = getCookie('playlist');
      if(data){
        try{
          playlist = JSON.parse(data);
          renderList();
        }catch(e){}
      }
    }

    function addVideo(id){
      fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${id}`)
        .then(r=>r.json())
        .then(meta=>{
          playlist.push({id,title:meta.title||id});
          savePlaylist();
          renderList();
          if(playlist.length-1 === currentIndex && !player){
            initPlayer(id);
          }else if(player && player.getPlayerState()!==1){
            playCurrent();
          }
        })
        .catch(()=>{ playlist.push({id,title:id}); savePlaylist(); renderList(); });
    }

    function renderList(){
      const ul=document.getElementById('songList');
      ul.innerHTML='';
      playlist.forEach((vid,i)=>{
        const li=document.createElement('li');
        li.textContent=(i===currentIndex?'â–¶ ':'')+vid.title;
        ul.appendChild(li);
      });
    }

    function onYouTubeIframeAPIReady(){
      loadPlaylist();
      if(playlist.length){
        initPlayer(playlist[0].id);
      }
    }

    function initPlayer(videoId){
      player = new YT.Player('player',{
        height:'0',
        width:'0',
        videoId,
        playerVars:{'autoplay':1,'controls':0},
        events:{
          'onReady':onPlayerReady,
          'onStateChange':onPlayerStateChange
        }
      });
    }
    function onPlayerReady(){
      startProgressTimer();
    }
    function onPlayerStateChange(event){
      if(event.data===0){ //ended
        nextSong();
      }else if(event.data===1){ //playing
        startProgressTimer();
        document.getElementById('playPauseBtn').textContent='Pause';
      }else if(event.data===2){ //paused
        stopProgressTimer();
        document.getElementById('playPauseBtn').textContent='Play';
      }
    }

    function playCurrent(){
      if(player){
        player.loadVideoById(playlist[currentIndex].id);
        renderList();
      }else{
        initPlayer(playlist[currentIndex].id);
      }
    }

    function nextSong(){
      if(playlist.length===0) return;
      currentIndex = (currentIndex+1)%playlist.length;
      playCurrent();
    }

    function togglePlay(){
      if(!player) return;
      const state=player.getPlayerState();
      if(state===1){ //playing
        player.pauseVideo();
      }else{
        player.playVideo();
      }
    }

    function startProgressTimer(){
      stopProgressTimer();
      progressTimer=setInterval(()=>{
        if(player && player.getDuration){
          const p = (player.getCurrentTime()/player.getDuration())*100;
          document.getElementById('progress').value=p||0;
        }
      },1000);
    }
    function stopProgressTimer(){
      clearInterval(progressTimer);
    }

    document.getElementById('addBtn').addEventListener('click',()=>{
      const id=document.getElementById('videoInput').value.trim();
      if(id){
        addVideo(id);
        document.getElementById('videoInput').value='';
      }
    });
    document.getElementById('skipBtn').addEventListener('click',nextSong);
    document.getElementById('playPauseBtn').addEventListener('click',togglePlay);
    document.getElementById('progress').addEventListener('input',e=>{
      if(player && player.seekTo){
        const seek = (e.target.value/100)*player.getDuration();
        player.seekTo(seek,true);
      }
    });

    window.addEventListener('beforeunload',()=>{savePlaylist();});
  </script>
</body>
</html>

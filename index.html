<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mattmusikspelaresajt 1.45</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@400;600&display=swap" rel="stylesheet">
  <style id="theme-style">
:root {
  --bg:#000; --panel:#111; --border:#333; --text:#fffcfc;
  --accent:#00877c; --accent-soft:#00cfbe; --gap:.65rem;
}
* { box-sizing:border-box; }
body { margin:0 auto; max-width:720px; padding:1.25rem; background:var(--bg); color:var(--text); font:400 1rem/1.45 "Overpass",Arial,sans-serif;}
h1 { margin:0 0 1.3rem;text-align:center;font-weight:600;letter-spacing:.03em }
a,button,input,select { font:inherit;color:inherit }
input[type=text],input[type=range],select { background:var(--panel); border:1px solid var(--border); color:var(--text); border-radius:4px; }
input[type=text],select { padding:.5rem .6rem }
button { padding:.5rem 1.35rem; border:none; border-radius:4px; cursor:pointer; background:var(--accent); color:#fff; transition:background .15s,transform .15s;}
button:not(:disabled):hover { background:var(--accent-soft) }
button:not(:disabled):active { transform:scale(.97) }
:focus-visible { outline:2px solid var(--accent);outline-offset:2px }
#nowPlaying { display:flex;align-items:center;gap:.75rem }
#nowTitle { flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
#videoWrap { position:relative;width:clamp(100px,28vw,100px);aspect-ratio:1;border-radius:6px;overflow:hidden;background:#000;}
#videoWrap #player { position:absolute;width:1px;height:1px;opacity:0;pointer-events:none }
#art { width:100%;height:100%;object-fit:cover;border-radius:6px;opacity:0;transition:opacity .4s }
#art[src] { opacity:1 }
#buffering { position:absolute;inset:0;display:none;place-content:center;backdrop-filter:blur(2px) }
#buffering::after { content:'';width:32px;height:32px;border:4px solid #fff3;border-top-color:#fff; border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin { to{transform:rotate(360deg)} }
.controls { display:flex;align-items:center;gap:var(--gap);flex-wrap:wrap; margin:1.05rem 0 var(--gap);}
.controls input[type=range] { flex:1 1 100%;margin-top:.45rem;height:7px;appearance:none; background:var(--border);border-radius:4px;}
.controls input[type=range]::-webkit-slider-thumb { appearance:none;width:14px;height:14px;border-radius:50%; background:var(--accent);border:0;margin-top:-3.5px;}
#time { font-variant-numeric:tabular-nums;opacity:.8;min-width:5.5rem }
@media(max-width:600px) {
  #time { flex:1 1 100%;text-align:left;margin-top:.25rem }
  .controls button {width:48px;height:48px;padding:0;font-size:1.25rem}
}
.search-bar { display:flex;flex-wrap:wrap;gap:var(--gap) }
.search-mode { display:flex;gap:.8rem;align-items:center;font-size:.9rem;margin:0 }
.hidden { display:none }
#queueWrap { max-height:50vh;overflow:auto;background:var(--panel);border:1px solid var(--border); border-radius:6px;scrollbar-width:thin;scrollbar-color:var(--accent) var(--panel);}
#queueWrap::-webkit-scrollbar { width:8px; }
#queueWrap::-webkit-scrollbar-track { background:var(--panel); }
#queueWrap::-webkit-scrollbar-thumb { background:var(--accent);border:2px solid var(--panel);border-radius:4px;}
#queueWrap::-webkit-scrollbar-thumb:hover { background:var(--accent-soft); }
#queue li { display:flex;align-items:center;gap:.45rem;padding:.55rem .65rem; border-bottom:1px solid var(--border);}
#queue li:hover { background:#181818 }
#queue li img.thumb { width:48px;height:48px;flex:0 0 auto;object-fit:cover;object-position:center; border-radius:4px;}
#queue li span.title { flex:1;cursor:pointer;user-select:none }
.drag-handle { cursor:grab;font-size:1.1rem;padding:0 .25rem;opacity:.7 }
.playlist-controls { margin-top:1.8rem;padding:1rem;background:var(--panel); border:1px solid var(--border);border-radius:6px;}
.playlist-controls h3 { margin:0 0 .8rem;font-weight:600 }
.playlist-controls button,label { margin-top:.5rem;margin-right:.7rem }
.toggle { position:relative;width:46px;height:24px;cursor:pointer }
.toggle input { opacity:0;width:0;height:0 }
.slider { position:absolute;inset:0;background:var(--panel);border:1px solid var(--border); border-radius:12px;transition:.2s;}
.slider::before { content:'';position:absolute;top:2px;left:2px;width:18px;height:18px; border-radius:50%;background:var(--accent);transition:.2s;}
.toggle input:checked+.slider::before { transform:translateX(22px);background:var(--accent-soft)}
  </style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h1 style="margin-bottom:0;">Mattmusikspelaresajt 1.45</h1>
    <label class="toggle" style="margin-left:auto;" title="Light/Dark mode">
      <input id="themeToggle" type="checkbox" aria-label="Toggle light/dark mode">
      <span class="slider"></span>
      <span id="themeLabel" style="font-size:0.95em;margin-left:0.5em;min-width:1.5em;display:inline-block;text-align:center;">üåô</span>
    </label>
  </div>
  <!-- now-playing -->
  <div id="nowPlaying">
    <div id="videoWrap">
      <div id="player" allow="autoplay"></div>
      <img id="art" alt="">
      <div id="buffering" aria-hidden="true"></div>
    </div>
    <span id="nowTitle"></span>
  </div>
  <!-- transport -->
  <div class="controls">
    <button id="prev">‚èÆ</button>
    <button id="playPause">‚ñ∂</button>
    <button id="skip">‚è≠</button>
    <span id="time">0:00 / 0:00</span>
    <input type="range" id="progress" min="0" max="100" value="0">
  </div>
  <!-- search -->
  <div class="search-bar">
    <div class="search-mode">
      <label class="toggle">
        <input id="modeToggle" type="checkbox" aria-label="Toggle to Paste-ID mode">
        <span class="slider"></span>
      </label>
    </div>
    <input id="artistInput" type="text" placeholder="Artist name">
    <input id="songInput" type="text" placeholder="Song title">
    <button id="searchBtn">Search & Play</button>
  </div>
  <h2>Music Queue</h2>
  <div id="queueWrap"><ul id="queue"></ul></div>
  <!-- playlists -->
  <div class="playlist-controls">
    <h3>Playlists</h3>
    <input id="playlistName" type="text" placeholder="New playlist name">
    <button id="savePlaylist">Save</button><br><br>
    <select id="playlistSelect"><option value="">‚Äî Load ‚Äî</option></select>
    <button id="deletePlaylist">Delete</button><br><br>
    <button id="exportPlaylist">Export</button>
    <label>Import <input type="file" id="importFile" accept=".json"></label>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
/* === Theme Toggle === */
const themeStyle=$("theme-style"),themeToggle=$("themeToggle"),themeLabel=$("themeLabel");
const css=[`
:root{--bg:#000;--panel:#111;--border:#333;--text:#fffcfc;--accent:#00877c;--accent-soft:#00cfbe;--gap:.65rem;}
#videoWrap{background:#000;}
#buffering::after{border:4px solid #fff3;border-top-color:#fff;}
#queue li:hover{background:#181818;}
`,`
:root{--bg:#f6f6f7;--panel:#fff;--border:#b3b3b3;--text:#151515;--accent:#007366;--accent-soft:#52c2b3;--gap:.65rem;}
#videoWrap{background:#eaeaea;}
#buffering::after{border:4px solid #0002;border-top-color:#007366;}
#queue li:hover{background:#f0f0f0;}
`];
function setTheme(d){themeStyle.innerHTML=themeStyle.innerHTML.replace(/:root\{[\s\S]*?\}([^}]*)}/,'')+(d?css[0]:css[1]);
themeLabel.textContent=d?"üåô":"‚òÄÔ∏è";
localStorage.setItem("theme",d?"dark":"light");}
themeToggle.onchange=()=>setTheme(themeToggle.checked);
(function(){let s=localStorage.getItem("theme"),p=window.matchMedia("(prefers-color-scheme: dark)").matches;
let d=s==="dark"||(!s&&p);themeToggle.checked=d;setTheme(d);})();

/* === DOM and State Cache === */
const $=id=>document.getElementById(id),ui={
  artist:$('artistInput'),song:$('songInput'),nowBox:$('nowPlaying'),nowTitle:$('nowTitle'),art:$('art'),buffering:$('buffering'),
  playBtn:$('playPause'),prevBtn:$('prev'),skipBtn:$('skip'),timeLabel:$('time'),progress:$('progress'),
  queueUL:$('queue'),listSel:$('playlistSelect'),modeToggle:$('modeToggle'),savePlaylist:$('savePlaylist'),
  deletePlaylist:$('deletePlaylist'),exportPlaylist:$('exportPlaylist'),importFile:$('importFile'),playlistName:$('playlistName'),searchBtn:$('searchBtn')
};
let queue=[],currentIdx=-1,player,playerReady=false,pendingPlay=null,vidDuration=0;
ui.progress.step='any';

/* === Mode Toggle === */
function setMode(){const c=ui.modeToggle.checked;ui.artist.classList.toggle('hidden',c);ui.song.placeholder=c?'YouTube video ID':'Song title';}
ui.modeToggle.onchange=setMode;setMode();

/* === Sortable queue === */
new Sortable(ui.queueUL,{handle:'.drag-handle',animation:150,onEnd:e=>{queue.splice(e.newIndex,0,queue.splice(e.oldIndex,1)[0]);saveQueue();}});

/* === Persistence (Queue & Playlists) === */
function loadQueue(){queue=JSON.parse(localStorage.getItem('musicQueue')||'[]');}
function saveQueue(){localStorage.setItem('musicQueue',JSON.stringify(queue));}
const LS='playlists';
function getLists(){return JSON.parse(localStorage.getItem(LS)||'{}');}
function setLists(o){localStorage.setItem(LS,JSON.stringify(o));}
function refreshSel(){ui.listSel.innerHTML='<option value="">‚Äî Load ‚Äî</option>';Object.keys(getLists()).sort().forEach(n=>ui.listSel.insertAdjacentHTML('beforeend',`<option>${n}</option>`));}

/* === YouTube API === */
function onYouTubeIframeAPIReady(){player=new YT.Player('player',{playerVars:{controls:0,playsinline:1},events:{
  onReady:()=>{playerReady=true;try{player.setPlaybackQuality('tiny');}catch{}if(pendingPlay!==null){playIdx(pendingPlay);pendingPlay=null;}startProgressLoop();},
  onStateChange:e=>{if(e.data===0)skip();ui.playBtn.textContent=e.data===1?'‚è∏':'‚ñ∂';ui.buffering.style.display=e.data===3?'grid':'none';}
}});}

/* === Helpers === */
async function fetchVideoInfo(id){try{const j=await(await fetch(`https://noembed.com/embed?url=https://youtu.be/${id}`)).json();
return{title:j.title||id,artist:(j.author_name||'').replace(/\s*[‚Äì-]\s*Topic\s*$/i,'')};}catch{return{title:id,artist:''};}}
function renderQueue(){ui.queueUL.innerHTML='';queue.forEach((it,i)=>ui.queueUL.insertAdjacentHTML('beforeend',`
  <li data-id="${it.id}"><span class="drag-handle">‚â°</span>
  <img class="thumb" src="https://i.ytimg.com/vi/${encodeURIComponent(it.id)}/mqdefault.jpg" alt="">
  <span class="title">${it.title}${it.artist?` <small style="opacity:.7">‚Äî ${it.artist}</small>`:''}</span>
  <button data-del="${i}">‚úï</button></li>`));}
function updateNow(it){if(!it){ui.nowBox.style.display='none';return;}
ui.art.src=`https://i.ytimg.com/vi/${encodeURIComponent(it.id)}/mqdefault.jpg`;ui.nowTitle.innerHTML=`${it.title}${it.artist?` <small>‚Äî ${it.artist}</small>`:''}`;ui.nowBox.style.display='flex';}

/* === Playback === */
function playIdx(i){if(!queue.length||i<0||i>=queue.length)return;if(!playerReady){pendingPlay=i;updateNow(queue[i]);return;}
currentIdx=i;player.loadVideoById(queue[i].id);updateNow(queue[i]);vidDuration=0;ui.timeLabel.textContent='0:00 / ‚Ä¶';}
function skip(){if(queue.length)playIdx((currentIdx+1)%queue.length);}

/* === Transport Controls === */
ui.playBtn.onclick=()=>playerReady&&(player.getPlayerState()===1?player.pauseVideo():player.playVideo());
ui.skipBtn.onclick=skip;
ui.prevBtn.onclick=()=>queue.length&&playIdx((currentIdx-1+queue.length)%queue.length);
ui.progress.oninput=function(){if(!playerReady||!vidDuration)return;const t=vidDuration*this.value/100;player.seekTo(t,true);
ui.timeLabel.textContent=formatTime(t)+' / '+formatTime(vidDuration);}
function formatTime(s){return`${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;}

/* === rAF progress === */
function startProgressLoop(){requestAnimationFrame(updateProgress);}
function updateProgress(){if(!playerReady)return requestAnimationFrame(updateProgress);
const cur=player.getCurrentTime(),dur=player.getDuration()||vidDuration;if(dur)vidDuration=dur;if(!dur)return requestAnimationFrame(updateProgress);
const pct=cur/dur*100,buf=player.getVideoLoadedFraction()*100;ui.progress.value=pct;
ui.timeLabel.textContent=`${formatTime(cur)} / ${formatTime(dur)}`;
ui.progress.style.background=`linear-gradient(to right,var(--accent) 0% ${pct}%,#555 ${pct}% ${buf}%,var(--border) ${buf}%,var(--border) 100%)`;
requestAnimationFrame(updateProgress);}

/* === Queue Events === */
ui.queueUL.onclick=e=>{const{del}=e.target.dataset;if(del!==undefined){queue.splice(del,1);currentIdx=Math.max(currentIdx-1,0);renderQueue();saveQueue();return;}
if(e.target.classList.contains('title'))playIdx([...ui.queueUL.children].indexOf(e.target.parentElement));};
ui.queueUL.oncontextmenu=e=>{const li=e.target.closest('li[data-id]');if(!li)return;e.preventDefault();window.open('https://youtu.be/'+li.dataset.id,'_blank');};

/* === Playlist Controls === */
ui.savePlaylist.onclick=()=>{const n=ui.playlistName.value.trim();if(!n||!queue.length)return;const l=getLists();l[n]=queue;setLists(l);refreshSel();alert('Playlist saved!');};
ui.deletePlaylist.onclick=()=>{if(!ui.listSel.value)return;const l=getLists();delete l[ui.listSel.value];setLists(l);refreshSel();ui.listSel.value='';};
ui.listSel.onchange=function(){if(!this.value)return;queue=[...getLists()[this.value]];renderQueue();saveQueue();playIdx(0);};
ui.exportPlaylist.onclick=()=>{const chosen=ui.listSel.value;let data,name;if(chosen){data=getLists()[chosen];name=chosen;}
else{if(!queue.length){alert('Nothing to export');return;}data=queue;name='CurrentQueue';}
const blob=new Blob([JSON.stringify({name,data})],{type:'application/json'});
const url=URL.createObjectURL(blob);Object.assign(document.createElement('a'),{href:url,download:name+'.json'}).click();URL.revokeObjectURL(url);};
ui.importFile.onchange=function(){const f=this.files[0];if(!f)return;const r=new FileReader();
r.onload=async e=>{try{const o=JSON.parse(e.target.result);if(!o.name||!Array.isArray(o.data))throw'bad';
for(const it of o.data)if(!it.artist)it.artist=(await fetchVideoInfo(it.id)).artist;const l=getLists();l[o.name]=o.data;setLists(l);refreshSel();alert('Imported ‚Äú'+o.name+'‚Äù playlist!');}
catch{alert('Invalid playlist file');}};r.readAsText(f);this.value='';};

/* === YouTube official-audio search === */
const YT_KEY='AIzaSyCtBUhn0t1AeiHivsdmw4ro5thw6R7Ijio';
async function searchOfficialAudio(artist,song){const url='https://www.googleapis.com/youtube/v3/search?'+new URLSearchParams({
key:YT_KEY,part:'snippet',type:'video',maxResults:10,videoCategoryId:10,q:`${song} "Provided to YouTube by" ${artist}`});
const j=await(await fetch(url)).json();if(!j.items?.length)return null;
const topicRE=new RegExp(`^${artist}\\s*-\\s*Topic$`,'i');let hit=j.items.find(v=>topicRE.test(v.snippet.channelTitle))||j.items[0];
const vid=hit.id.videoId;const vd=await(await fetch('https://www.googleapis.com/youtube/v3/videos?'+
new URLSearchParams({key:YT_KEY,part:'snippet',id:vid}))).json();
const good=vd.items?.[0]?.snippet?.description?.toLowerCase().includes('provided to youtube by');return good?hit:null;}
ui.searchBtn.onclick=async()=>{const code=ui.modeToggle.checked,artist=ui.artist.value.trim(),song=ui.song.value.trim();
if(code){const id=song;if(!id){alert('Paste a YouTube ID');return;}const info=await fetchVideoInfo(id);
queue.unshift({id,title:info.title,artist:info.artist});saveQueue();renderQueue();playIdx(0);ui.song.value='';return;}
if(!artist||!song){alert('Type both artist and song');return;}
const hit=await searchOfficialAudio(artist,song);if(!hit){alert('No official audio found üòï');return;}
queue.unshift({id:hit.id.videoId,title:hit.snippet.title,artist:hit.snippet.channelTitle.replace(/\s*-\s*Topic\s*$/i,'').trim()});
saveQueue();renderQueue();playIdx(0);ui.artist.value='';ui.song.value='';};

/* === Init === */
loadQueue();renderQueue();refreshSel();if(queue.length)playIdx(0);
  </script>
  <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
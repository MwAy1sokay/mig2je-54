<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Matt's Music Embedder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- 🎵 google font for a bit of flair -->
  <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      /* one place to tweak the entire palette */
      --bg:#000;                 /* page background */
      --panel:#111;              /* cards / list background */
      --border:#333;             /* subtle borders */
      --text:#eaeaea;            /* main text */
      --accent:#0097a7;          /* main teal-blue (buttons, focus rings)  */
      --accent-soft:#26c6da;     /* hover / softer version                */
      --gap:.65rem;
    }
    *{box-sizing:border-box;}
    body{
      font-family:"Overpass",Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0 auto;
      max-width:720px;
      padding:1.25rem;
      line-height:1.45;
    }
    h1{
      text-align:center;
      margin:0 0 1.3rem;
      font-weight:600;
      letter-spacing:.03em;
    }
    a,button,input,select{
      font-family:inherit;
      font-size:1rem;
      color:inherit;
    }

    /* -------- generic elements -------- */
    input[type="text"],
    input[type="range"],
    select{
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:4px;
    }
    input[type="text"],
    select{
      padding:.5rem .6rem;
      width:100%;
    }

    button{
      padding:.5rem 1.35rem;
      background:var(--accent);
      border:none;
      border-radius:4px;
      color:#fff;
      cursor:pointer;
      transition:background .15s,transform .15s;
    }
    button:disabled{
      opacity:.35;
      cursor:default;
    }
    button:not(:disabled):hover{background:var(--accent-soft);}
    button:not(:disabled):active{transform:scale(.97);}

    button:focus-visible,
    input:focus-visible,
    select:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }

    /* -------- layout sections -------- */
  
    /* Now Playing */
    #nowPlaying{
      display:none;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:6px;
      padding:.7rem .9rem;
      font-weight:600;
      margin-top:var(--gap);
    }

    /* transport */
    .controls{
      display:flex;
      align-items:center;
      gap:var(--gap);
      flex-wrap:wrap;
      margin-top:1.05rem;
    }
    .controls button{
      flex:0 0 auto;
    }
    #progress{
      flex:1 1 100%;
      margin-top:.45rem;
      height:7px;
      appearance:none;
      background:var(--border);
      border-radius:4px;
    }
    #progress::-webkit-slider-thumb{
      appearance:none;
      width:14px;
      height:14px;
      border-radius:50%;
      background:var(--accent);
      border:0;
      cursor:pointer;
      margin-top:-3.5px;   /* center thumb vertically */
    }

    /* Music Queue */
    h2{margin:1.6rem 0 .7rem;}
    #queueWrap{
      max-height:50vh;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:6px;
      background:var(--panel);
    }
    #queue li{
      display:flex;
      align-items:center;
      gap:.45rem;
      padding:.55rem .65rem;
      border-bottom:1px solid var(--border);
      transition:background .15s;
    }
    #queue li:last-child{border-bottom:none;}
    #queue li span.title{
      flex:1;
      cursor:pointer;
      user-select:none;
    }
    #queue li:hover{background:#181818;}
    #queue li button{padding:.25rem .7rem;}

    /* Playlists block */
    .playlist-controls{
      margin-top:1.8rem;
      padding:1rem;
      border:1px solid var(--border);
      border-radius:6px;
      background:var(--panel);
    }
    .playlist-controls h3{margin-top:0;margin-bottom:.8rem;font-weight:600;}
    .playlist-controls button,label{margin-top:.5rem;margin-right:.7rem;}
    .playlist-controls label{cursor:pointer;}
    .playlist-controls input[type="file"]{display:none;}

    /* -------- small screens -------- */
    @media(max-width:600px){
      .controls button{flex:1 1 46%;}
      #progress{flex:1 1 100%;}
      #queue li button{padding:.3rem .75rem;}
    }
    /* ---------- video container ---------- */
#videoWrap{
  position:relative;
  width:100%;                 /* full width of the page */
  padding-top:56.25%;         /* 16 : 9 aspect-ratio hack */
  margin-top:1rem;
  border:1px solid var(--border);
  border-radius:6px;
  background:#000;
}
#videoWrap #player{
  position:absolute;
  top:0; left:0;
  width:100%; height:100%;
}
  </style>
</head>
<body>
  <h1>Matt's Music Embedder</h1>

  <input id="videoId" placeholder="YouTube video ID">
  <button id="addBtn" style="margin-top:.75rem">Add &amp; Play</button>

  <!-- Now Playing -->
  <div id="nowPlaying"><span id="nowTitle"></span></div>

  <!-- Transport -->
  <div class="controls">
    <button id="playPause">Play</button>
    <button id="skip">Skip</button>
    <button id="pipBtn">Background</button>
    <input type="range" id="progress" min="0" max="100" value="0">
  </div>

  <h2>Music Queue</h2>
  <div id="queueWrap"><ul id="queue"></ul></div>

  <!-- Playlists -->
  <div class="playlist-controls">
    <h3>Playlists</h3>
    <input id="playlistName" placeholder="New playlist name">
    <button id="savePlaylist">Save Playlist</button><br><br>
    <select id="playlistSelect"><option value="">— Load playlist —</option></select>
    <button id="deletePlaylist">Delete</button><br><br>
    <button id="exportPlaylist">Export</button>
    <label>Import <input type="file" id="importFile" accept=".json"></label>
  </div>

 <div id="videoWrap">
  <div id="player"
       allow="autoplay; picture-in-picture"></div>
</div>

<!-- =========  JS START  ========= -->
<script>
/* ------------------------------------------------------------------
   GLOBAL STATE
------------------------------------------------------------------ */
let queue = [], currentIdx = -1;
let player, playerReady = false, pendingPlayIdx = null;

const queueEl = document.getElementById('queue');
const nowBox  = document.getElementById('nowPlaying');
const nowT    = document.getElementById('nowTitle');
const playBtn = document.getElementById('playPause');
const pipBtn  = document.getElementById('pipBtn');

/* ------------------------------------------------------------------
   COOKIE LIST  (queue)
------------------------------------------------------------------ */
const loadQueue = () => {
  const m = document.cookie.match(/(?:^|;\\s*)queue=([^;]+)/);
  queue = m ? JSON.parse(decodeURIComponent(m[1])) : [];
};
const saveQueue = () =>
  (document.cookie =
    'queue=' + encodeURIComponent(JSON.stringify(queue)) +
    ';max-age=31536000;path=/');

/* ------------------------------------------------------------------
   PLAYLISTS  (localStorage)
------------------------------------------------------------------ */
const LS_KEY   = 'playlists',
      selPl    = document.getElementById('playlistSelect');
const getLists = () => JSON.parse(localStorage.getItem(LS_KEY) || '{}');
const setLists = o  => localStorage.setItem(LS_KEY, JSON.stringify(o));
const refreshSel = () => {
  selPl.innerHTML = '<option value="">— Load playlist —</option>';
  Object.keys(getLists()).sort()
        .forEach(n => selPl.insertAdjacentHTML('beforeend', `<option>${n}</option>`));
};

/* ------------------------------------------------------------------
   YOUTUBE IFRAME API
------------------------------------------------------------------ */
function onYouTubeIframeAPIReady () {
  player = new YT.Player('player', {
    height: '225',
    width : '400',
    playerVars: {
      controls: 1,        // <— show YouTube overlay
      modestbranding: 1,  // shrink the logo
      playsinline: 1      // stay inline on iOS instead of fullscreen
    },
    events: {
      onReady: () => {
        playerReady = true;
        setTiny();
        if (pendingPlayIdx !== null) {
          const idx = pendingPlayIdx;
          pendingPlayIdx = null;
          playIdx(idx);
        }
      },
      onStateChange: e => {
        if (e.data === 0) skip();        // ended
        if (e.data === 1) setTiny();     // force 144 p

        /* sync Play / Pause label */
        if (e.data === 1) {              // playing
          playBtn.textContent = 'Pause';
        } else if ([2, -1, 5].includes(e.data)) {   // paused / cued
          playBtn.textContent = 'Play';
        }
      }
    }
  });
}
const setTiny = () => { try { player.setPlaybackQuality('tiny'); } catch {} };

/* ------------------------------------------------------------------
   MEDIA SESSION  (lock-screen controls)
------------------------------------------------------------------ */
const setMediaMeta = ('mediaSession' in navigator)
  ? (item) => {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: item.title || 'YouTube Track',
        artist: 'Matt’s Music Embedder',
        artwork: [
          { src:`https://img.youtube.com/vi/${item.id}/hqdefault.jpg`,
            sizes:'320x180', type:'image/jpeg' }
        ]
      });
    }
  : () => {};

/* ------------------------------------------------------------------
   UTILS
------------------------------------------------------------------ */
const fetchTitle = async id => {
  try {
    const r = await fetch(`https://noembed.com/embed?url=https://youtu.be/${id}`);
    const j = await r.json();
    return j.title || id;
  } catch { return id; }
};

const renderQueue = () => {
  queueEl.innerHTML = '';
  queue.forEach((it,i) =>
    queueEl.insertAdjacentHTML('beforeend', `
      <li>
        <span class="title">${it.title || it.id}</span>
        <button ${i?'':'disabled'} data-up="${i}">↑</button>
        <button ${i<queue.length-1?'':'disabled'} data-down="${i}">↓</button>
        <button data-del="${i}">✕</button>
      </li>`));
};

const updateNow = it => {
  if (!it) { nowBox.style.display = 'none'; return; }
  nowT.textContent = it.title || it.id;
  nowBox.style.display = 'block';
  setMediaMeta(it);
};

/* ------------------------------------------------------------------
   PLAYBACK
------------------------------------------------------------------ */
function playIdx (i) {
  if (!queue.length || i < 0 || i >= queue.length) return;

  if (!playerReady) {                       // wait for API
    pendingPlayIdx = i;
    updateNow(queue[i]);
    return;
  }

  currentIdx = i;
  player.loadVideoById(queue[i].id);
  setTiny();
  updateNow(queue[i]);                      // button flips on state===1
}

const skip = () => {
  if (!queue.length) return;
  playIdx((currentIdx + 1) % queue.length); // loop around
};

/* ------------------------------------------------------------------
   UI EVENTS
------------------------------------------------------------------ */
/* Add & Play */
document.getElementById('addBtn').addEventListener('click', async () => {
  const id = document.getElementById('videoId').value.trim();
  if (!id) return;
  const title = await fetchTitle(id);
  queue.unshift({ id, title });
  saveQueue(); renderQueue(); playIdx(0);
  document.getElementById('videoId').value = '';
});

/* Play / Pause */
playBtn.addEventListener('click', () => {
  if (!playerReady) return;
  if (player.getPlayerState() === 1) player.pauseVideo();
  else                               player.playVideo();
});

/* Skip */
document.getElementById('skip').addEventListener('click', skip);

/* Picture-in-Picture / Background */
pipBtn.addEventListener('click', async () => {
  if (!playerReady) return;
  const iframe = player.getIframe();
  if ('requestPictureInPicture' in iframe) {
    try { await iframe.requestPictureInPicture(); }
    catch { /* ignored */ }
  } else {
    alert('Picture-in-Picture isn’t supported on this device.');
  }
});

/* Progress bar */
setInterval(() => {
  if (!playerReady || !player.getDuration) return;
  const d = player.getDuration();
  if (d) document.getElementById('progress').value =
           (player.getCurrentTime() / d) * 100;
}, 1000);

document.getElementById('progress').addEventListener('input', function () {
  if (playerReady && player.getDuration)
    player.seekTo((player.getDuration() * this.value) / 100, true);
});

/* Queue list interactions */
queueEl.addEventListener('click', e => {
  const { up, down, del } = e.target.dataset;
  if (up)        [queue[up-1], queue[up]] = [queue[up], queue[up-1]];
  else if (down) [queue[+down], queue[+down+1]] = [queue[+down+1], queue[+down]];
  else if (del)  { queue.splice(del,1); if (currentIdx >= del) currentIdx--; }
  else if (e.target.classList.contains('title')) {
    playIdx([...queueEl.children].indexOf(e.target.parentElement));
    return;
  } else return;

  renderQueue(); saveQueue();
});

/* ---------- Playlists ---------- */
document.getElementById('savePlaylist').addEventListener('click', () => {
  const n = document.getElementById('playlistName').value.trim();
  if (!n || !queue.length) return;
  const l = getLists(); l[n] = queue; setLists(l);
  refreshSel(); alert('Playlist saved!');
});

selPl.addEventListener('change', function () {
  if (!this.value) return;
  queue = [...getLists()[this.value]];
  renderQueue(); saveQueue(); playIdx(0);
});

document.getElementById('deletePlaylist').addEventListener('click', () => {
  if (!selPl.value) return;
  const l = getLists(); delete l[selPl.value]; setLists(l);
  refreshSel(); selPl.value = '';
});

/* ---------- Export / Import ---------- */
document.getElementById('exportPlaylist').addEventListener('click', () => {
  const chosen = selPl.value;
  let data, name;
  if (chosen) { data = getLists()[chosen]; name = chosen; }
  else {
    if (!queue.length) { alert('Nothing to export'); return; }
    data = queue; name = 'CurrentQueue';
  }
  const blob = new Blob([JSON.stringify({ name, data })],
                        { type:'application/json' });
  const url  = URL.createObjectURL(blob);
  Object.assign(document.createElement('a'),
    { href:url, download:name+'.json' }).click();
  URL.revokeObjectURL(url);
});

document.getElementById('importFile').addEventListener('change', function () {
  const f = this.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = e => {
    try {
      const o = JSON.parse(e.target.result);
      if (!o.name || !Array.isArray(o.data)) throw 'bad';
      const l = getLists(); l[o.name] = o.data; setLists(l);
      refreshSel(); alert('Imported “‘'+o.name+'” playlist!');
    } catch { alert('Invalid playlist file'); }
  };
  r.readAsText(f); this.value = '';
});

/* ------------------------------------------------------------------
   INITIALISATION
------------------------------------------------------------------ */
loadQueue();
renderQueue();
refreshSel();
updateNow(queue[currentIdx]);
if (queue.length) playIdx(0);          // will actually start once API ready
</script>

<!-- Load the YouTube API *after* the code so the callback exists -->
<script src="https://www.youtube.com/iframe_api"></script>
<!-- =========  JS END  ========= -->

</body>
</html>

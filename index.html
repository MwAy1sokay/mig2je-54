<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mattmusikspelaresajt 1.46</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Overpass:wght@400;600&display=swap" rel="stylesheet">
  <style id="theme-style">
:root {
  --bg:#000; --panel:#111; --border:#333; --text:#fffcfc;
  --accent:#00877c; --accent-soft:#00cfbe; --gap:.65rem;
  --row-hover:#181818;
}
* { box-sizing:border-box; }
body {
  margin:0 auto; max-width:720px; padding:1.25rem;
  background:var(--bg); color:var(--text);
  font:400 1rem/1.45 "Overpass",Arial,sans-serif;
}
h1 { margin:0 0 1.3rem;text-align:center;font-weight:600;letter-spacing:.03em }
a,button,input,select { font:inherit;color:inherit }
input[type=text],input[type=range],select {
  background:var(--panel); border:1px solid var(--border);
  color:var(--text); border-radius:4px;
}
input[type=text],select { padding:.5rem .6rem }
button {
  padding:.5rem 1.35rem; border:none; border-radius:4px; cursor:pointer;
  background:var(--accent); color:#fff; transition:background .15s,transform .15s;
}
button:not(:disabled):hover { background:var(--accent-soft) }
button:not(:disabled):active { transform:scale(.97) }
:focus-visible { outline:2px solid var(--accent);outline-offset:2px }
#nowPlaying { display:flex;align-items:center;gap:.75rem }
#nowTitle { flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
#videoWrap {
  position:relative;width:clamp(100px,28vw,100px);aspect-ratio:1;border-radius:6px;
  overflow:hidden;background:#000;
}
#videoWrap #player { position:absolute;width:1px;height:1px;opacity:0;pointer-events:none }
#art { width:100%;height:100%;object-fit:cover;border-radius:6px;opacity:0;transition:opacity .4s }
#art[src] { opacity:1 }
#buffering {
  position:absolute;inset:0;display:none;place-content:center;backdrop-filter:blur(2px)
}
#buffering::after {
  content:'';width:32px;height:32px;border:4px solid #fff3;border-top-color:#fff;
  border-radius:50%;animation:spin .8s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }
.controls {
  display:flex;align-items:center;gap:var(--gap);flex-wrap:wrap;
  margin:1.05rem 0 var(--gap);
}
.controls input[type=range] {
  flex:1 1 100%;margin-top:.45rem;height:7px;appearance:none;
  background:var(--border);border-radius:4px;
}
.controls input[type=range]::-webkit-slider-thumb {
  appearance:none;width:14px;height:14px;border-radius:50%;
  background:var(--accent);border:0;margin-top:-3.5px;
}
#time { font-variant-numeric:tabular-nums;opacity:.8;min-width:5.5rem }
/* --- Play/Pause Button Circle --- */
#playPause {
  background: var(--accent);
  border: none;
  padding: 0;
  width: 96px;
  height: 96px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background .15s, box-shadow .15s;
  position: relative;
  box-shadow: 0 4px 16px 0 #00877c40;
}
#playPause:focus-visible {
  outline: 2px solid var(--accent-soft);
}
#playPause:not(:disabled):hover {
  background: var(--accent-soft);
}
#playPauseIcon {
  width: 48px;
  height: 48px;
  display: block;
  margin: 0 auto;
  pointer-events: none;
}
/* --- Previous/Next Button Circles --- */
.circle-btn {
  background: var(--accent);
  border: none;
  padding: 0;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background .15s, box-shadow .15s;
  position: relative;
  box-shadow: 0 4px 16px 0 #00877c40;
}
.circle-btn:focus-visible {
  outline: 2px solid var(--accent-soft);
}
.circle-btn:not(:disabled):hover {
  background: var(--accent-soft);
}
#prevIcon,
#skipIcon {
  width: 28px;
  height: 28px;
  display: block;
  margin: 0 auto;
  pointer-events: none;
}
@media(max-width: 820px) {
  body { max-width: 100vw; padding: 1rem 0.5rem; }
}
@media(max-width: 600px) {
  #playPause { width: 72px; height: 72px; }
  #playPauseIcon { width: 34px; height: 34px; }
  .circle-btn { width: 40px; height: 40px; }
  #prevIcon, #skipIcon { width: 18px; height: 18px; }
}
@media(max-width: 430px) {
  #playPause { width: 60px; height: 60px; }
  #playPauseIcon { width: 22px; height: 22px; }
  .circle-btn { width: 32px; height: 32px; }
  #prevIcon, #skipIcon { width: 12px; height: 12px; }
}
/* --- rest of your CSS unchanged --- */
/* ... (all your existing CSS continues here) ... */
  </style>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h1 style="margin-bottom:0;">Mattmusikspelaresajt 1.46</h1>
    <label class="theme-toggle-label" title="Light/Dark mode">
      <span class="theme-toggle">
        <input id="themeToggle" type="checkbox" aria-label="Toggle light/dark mode">
        <span class="slider"></span>
      </span>
      <span id="themeLabel" class="theme-icon">ðŸŒ™</span>
    </label>
  </div>
  <!-- now-playing -->
  <div id="nowPlaying">
    <div id="videoWrap">
      <div id="player" allow="autoplay"></div>
      <img id="art" alt="">
      <div id="buffering" aria-hidden="true"></div>
    </div>
    <span id="nowTitle"></span>
  </div>
  <!-- transport -->
  <div class="controls">
    <button id="prev" class="circle-btn" aria-label="Previous">
      <img id="prevIcon" src="backwards.svg" alt="Previous" width="28" height="28">
    </button>
    <button id="playPause" aria-label="Play">
      <img id="playPauseIcon" src="play.svg" alt="Play" width="48" height="48">
    </button>
    <button id="skip" class="circle-btn" aria-label="Next">
      <img id="skipIcon" src="forwards.svg" alt="Next" width="28" height="28">
    </button>
    <span id="time">0:00 / 0:00</span>
    <input type="range" id="progress" min="0" max="100" value="0">
  </div>
  <!-- search -->
  <div class="search-bar">
    <div class="search-mode">
      <label class="toggle">
        <input id="modeToggle" type="checkbox" aria-label="Toggle to Paste-ID mode">
        <span class="slider"></span>
      </label>
    </div>
    <input id="artistInput" type="text" placeholder="Artist name">
    <input id="songInput" type="text" placeholder="Song title">
    <button id="searchBtn">Search & Play</button>
  </div>
  <div style="display:flex;align-items:center;gap:.75rem;">
    <h2 style="margin:0;">Music Queue</h2>
    <button id="shuffleBtn" title="Shuffle queue" style="padding:0.45em 1.2em;font-size:1.15em;display:flex;align-items:center;gap:.5em;">
      <span aria-hidden="true" style="font-size:1.1em;">ðŸ”€</span> Shuffle
    </button>
  </div>
  <div id="queueWrap"><ul id="queue"></ul></div>
  <!-- playlists -->
  <div class="playlist-controls">
    <h3>Playlists</h3>
    <input id="playlistName" type="text" placeholder="New playlist name">
    <button id="savePlaylist">Save</button><br><br>
    <select id="playlistSelect"><option value="">â€” Load â€”</option></select>
    <button id="deletePlaylist">Delete</button><br><br>
    <button id="exportPlaylist">Export</button>
    <label>Import <input type="file" id="importFile" accept=".json"></label>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Theme Toggle Script (using CSS variables directly) -->
  <script>
(function(){
  const darkVars = {
    '--bg': '#000',
    '--panel': '#111',
    '--border': '#333',
    '--text': '#fffcfc',
    '--accent': '#00877c',
    '--accent-soft': '#00cfbe',
    '--gap': '.65rem',
    '--row-hover': '#181818'
  };
  const lightVars = {
    '--bg': '#f6f6f7',
    '--panel': '#fff',
    '--border': '#b3b3b3',
    '--text': '#151515',
    '--accent': '#007366',
    '--accent-soft': '#52c2b3',
    '--gap': '.65rem',
    '--row-hover': '#e6edeb'
  };
  const themeToggle = document.getElementById("themeToggle");
  const themeLabel = document.getElementById("themeLabel");

  function setTheme(dark) {
    const vars = dark ? darkVars : lightVars;
    Object.keys(vars).forEach(k => document.documentElement.style.setProperty(k, vars[k]));
    themeLabel.textContent = dark ? "ðŸŒ™" : "â˜€ï¸";
    localStorage.setItem("theme", dark ? "dark" : "light");
  }

  themeToggle.onchange = () => setTheme(themeToggle.checked);

  let stored = localStorage.getItem("theme"),
      prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches,
      dark = stored === "dark" || (!stored && prefersDark);

  themeToggle.checked = dark;
  setTheme(dark);
})();
  </script>
  <script>
/* === DOM and State Cache === */
const $ = id => document.getElementById(id);
const ui = {
  artist: $('artistInput'),
  song: $('songInput'),
  nowBox: $('nowPlaying'),
  nowTitle: $('nowTitle'),
  art: $('art'),
  buffering: $('buffering'),
  playBtn: $('playPause'),
  prevBtn: $('prev'),
  skipBtn: $('skip'),
  timeLabel: $('time'),
  progress: $('progress'),
  queueUL: $('queue'),
  listSel: $('playlistSelect'),
  modeToggle: $('modeToggle'),
  savePlaylist: $('savePlaylist'),
  deletePlaylist: $('deletePlaylist'),
  exportPlaylist: $('exportPlaylist'),
  importFile: $('importFile'),
  playlistName: $('playlistName'),
  searchBtn: $('searchBtn'),
  shuffleBtn: $('shuffleBtn'),
  prevIcon: $('prevIcon'),
  skipIcon: $('skipIcon'),
};
let queue = [], currentIdx = -1, player, playerReady = false, pendingPlay = null, vidDuration = 0;

ui.progress.step = 'any';

/* === Shuffle Button === */
ui.shuffleBtn.onclick = function() {
  // Fisher-Yates shuffle
  for (let i = queue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [queue[i], queue[j]] = [queue[j], queue[i]];
  }
  renderQueue();
  saveQueue();
};

/* === Mode Toggle === */
function setMode() {
  const code = ui.modeToggle.checked;
  ui.artist.classList.toggle('hidden', code);
  ui.song.placeholder = code ? 'YouTube video ID' : 'Song title';
}
ui.modeToggle.onchange = setMode;
setMode();

/* === Sortable queue === */
new Sortable(ui.queueUL, {
  handle: '.drag-handle',
  animation: 150,
  onEnd: e => {
    queue.splice(e.newIndex, 0, queue.splice(e.oldIndex, 1)[0]);
    saveQueue();
  }
});

/* === Persistence (Queue & Playlists) === */
function loadQueue() {
  queue = JSON.parse(localStorage.getItem('musicQueue') || '[]');
}
function saveQueue() {
  localStorage.setItem('musicQueue', JSON.stringify(queue));
}
const LS = 'playlists';
function getLists() { return JSON.parse(localStorage.getItem(LS) || '{}'); }
function setLists(o) { localStorage.setItem(LS, JSON.stringify(o)); }
function refreshSel() {
  ui.listSel.innerHTML = '<option value="">â€” Load â€”</option>';
  Object.keys(getLists()).sort().forEach(n =>
    ui.listSel.insertAdjacentHTML('beforeend', `<option>${n}</option>`));
}

/* === YouTube API === */
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    playerVars: { controls: 0, playsinline: 1 },
    events: {
      onReady: () => {
        playerReady = true;
        try { player.setPlaybackQuality('tiny'); } catch {}
        if (pendingPlay !== null) { playIdx(pendingPlay); pendingPlay = null; }
        startProgressLoop();
      },
      onStateChange: e => {
        // Play: 1, Pause: 2, Ended: 0, Buffering: 3
        const icon = document.getElementById('playPauseIcon');
        if (e.data === 1) {
          icon.src = 'pause.svg';
          icon.alt = 'Pause';
          ui.playBtn.setAttribute('aria-label', 'Pause');
        } else {
          icon.src = 'play.svg';
          icon.alt = 'Play';
          ui.playBtn.setAttribute('aria-label', 'Play');
        }
        if (e.data === 0) skip();
        ui.buffering.style.display = e.data === 3 ? 'grid' : 'none';
      }
    }
  });
}

/* === Helpers === */
async function fetchVideoInfo(id) {
  try {
    const j = await (await fetch(`https://noembed.com/embed?url=https://youtu.be/${id}`)).json();
    return { title: j.title || id, artist: (j.author_name || '').replace(/\s*[â€“-]\s*Topic\s*$/i, '') };
  } catch { return { title: id, artist: '' }; }
}
function renderQueue() {
  ui.queueUL.innerHTML = '';
  queue.forEach((it, i) => ui.queueUL.insertAdjacentHTML('beforeend', `
    <li data-id="${it.id}">
      <span class="drag-handle">â‰¡</span>
      <img class="thumb" src="https://i.ytimg.com/vi/${encodeURIComponent(it.id)}/hqdefault.jpg" alt="">
      <span class="title">${it.title}${it.artist ? ` <small style="opacity:.7">â€” ${it.artist}</small>` : ''}</span>
      <button data-del="${i}">âœ•</button>
    </li>`));
}
function updateNow(it) {
  if (!it) { ui.nowBox.style.display = 'none'; return; }
  ui.art.src = `https://i.ytimg.com/vi/${encodeURIComponent(it.id)}/maxresdefault.jpg`;
  ui.nowTitle.innerHTML = `${it.title}${it.artist ? ` <small>â€” ${it.artist}</small>` : ''}`;
  ui.nowBox.style.display = 'flex';
}

/* === Playback === */
function playIdx(i) {
  if (!queue.length || i < 0 || i >= queue.length) return;
  if (!playerReady) { pendingPlay = i; updateNow(queue[i]); return; }
  currentIdx = i; player.loadVideoById(queue[i].id);
  updateNow(queue[i]); vidDuration = 0; ui.timeLabel.textContent = '0:00 / â€¦';
}
function skip() {
  if (queue.length) playIdx((currentIdx + 1) % queue.length);
}

/* === Transport Controls === */
ui.playBtn.onclick = () => {
  if (!playerReady) return;
  // Play: 1, Pause: 2
  const state = player.getPlayerState();
  if (state === 1) {
    player.pauseVideo();
    // Will update icon in onStateChange
  } else {
    player.playVideo();
    // Will update icon in onStateChange
  }
};
ui.skipBtn.onclick = skip;
ui.prevBtn.onclick = () => queue.length && playIdx((currentIdx - 1 + queue.length) % queue.length);
ui.progress.oninput = function () {
  if (!playerReady || !vidDuration) return;
  const t = vidDuration * this.value / 100;
  player.seekTo(t, true);
  ui.timeLabel.textContent = formatTime(t) + ' / ' + formatTime(vidDuration);
};
function formatTime(s) {
  return `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`;
}

/* === rAF progress === */
function startProgressLoop() { requestAnimationFrame(updateProgress); }
function updateProgress() {
  if (!playerReady) return requestAnimationFrame(updateProgress);
  const cur = player.getCurrentTime(), dur = player.getDuration() || vidDuration;
  if (dur) vidDuration = dur; if (!dur) return requestAnimationFrame(updateProgress);
  const pct = cur / dur * 100, buf = player.getVideoLoadedFraction() * 100;
  ui.progress.value = pct;
  ui.timeLabel.textContent = `${formatTime(cur)} / ${formatTime(dur)}`;
  ui.progress.style.background = `linear-gradient(to right,var(--accent) 0% ${pct}%,#555 ${pct}% ${buf}%,var(--border) ${buf}%,var(--border) 100%)`;
  requestAnimationFrame(updateProgress);
}

/* === Queue Events === */
ui.queueUL.onclick = e => {
  const { del } = e.target.dataset;
  if (del !== undefined) {
    queue.splice(del, 1);
    currentIdx = Math.max(currentIdx - 1, 0);
    renderQueue(); saveQueue(); return;
  }
  if (e.target.classList.contains('title'))
    playIdx([...ui.queueUL.children].indexOf(e.target.parentElement));
};
ui.queueUL.oncontextmenu = e => {
  const li = e.target.closest('li[data-id]'); if (!li) return;
  e.preventDefault();
  window.open('https://youtu.be/' + li.dataset.id, '_blank');
};

/* === Playlist Controls === */
ui.savePlaylist.onclick = () => {
  const n = ui.playlistName.value.trim(); if (!n || !queue.length) return;
  const l = getLists(); l[n] = queue; setLists(l); refreshSel(); alert('Playlist saved!');
};
ui.deletePlaylist.onclick = () => {
  if (!ui.listSel.value) return;
  const l = getLists(); delete l[ui.listSel.value]; setLists(l);
  refreshSel(); ui.listSel.value = '';
};
ui.listSel.onchange = function () {
  if (!this.value) return;
  queue = [...getLists()[this.value]];
  renderQueue(); saveQueue(); playIdx(0);
};
ui.exportPlaylist.onclick = () => {
  const chosen = ui.listSel.value; let data, name;
  if (chosen) { data = getLists()[chosen]; name = chosen; }
  else { if (!queue.length) { alert('Nothing to export'); return; } data = queue; name = 'CurrentQueue'; }
  const blob = new Blob([JSON.stringify({ name, data })], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  Object.assign(document.createElement('a'), { href: url, download: name + '.json' }).click();
  URL.revokeObjectURL(url);
};
ui.importFile.onchange = function () {
  const f = this.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = async e => {
    try {
      const o = JSON.parse(e.target.result);
      if (!o.name || !Array.isArray(o.data)) throw 'bad';
      for (const it of o.data) if (!it.artist) it.artist = (await fetchVideoInfo(it.id)).artist;
      const l = getLists(); l[o.name] = o.data; setLists(l); refreshSel();
      alert('Imported â€œ' + o.name + 'â€ playlist!');
    } catch { alert('Invalid playlist file'); }
  }; r.readAsText(f); this.value = '';
};

/* === YouTube official-audio search === */
const YT_KEY = 'AIzaSyCtBUhn0t1AeiHivsdmw4ro5thw6R7Ijio';
async function searchOfficialAudio(artist, song) {
  const url = 'https://www.googleapis.com/youtube/v3/search?' + new URLSearchParams({
    key: YT_KEY, part: 'snippet', type: 'video', maxResults: 10, videoCategoryId: 10,
    q: `${song} "Provided to YouTube by" ${artist}`
  });
  const j = await (await fetch(url)).json(); if (!j.items?.length) return null;
  const topicRE = new RegExp(`^${artist}\\s*-\\s*Topic$`, 'i');
  let hit = j.items.find(v => topicRE.test(v.snippet.channelTitle)) || j.items[0];
  const vid = hit.id.videoId;
  const vd = await (await fetch('https://www.googleapis.com/youtube/v3/videos?' +
    new URLSearchParams({ key: YT_KEY, part: 'snippet', id: vid }))).json();
  const good = vd.items?.[0]?.snippet?.description?.toLowerCase()
    .includes('provided to youtube by');
  return good ? hit : null;
}
ui.searchBtn.onclick = async () => {
  const code = ui.modeToggle.checked,
        artist = ui.artist.value.trim(), song = ui.song.value.trim();
  if (code) {
    const id = song; if (!id) { alert('Paste a YouTube ID'); return; }
    const info = await fetchVideoInfo(id);
    queue.unshift({ id, title: info.title, artist: info.artist });
    saveQueue(); renderQueue(); playIdx(0); ui.song.value = ''; return;
  }
  if (!artist || !song) { alert('Type both artist and song'); return; }
  const hit = await searchOfficialAudio(artist, song);
  if (!hit) { alert('No official audio found ðŸ˜•'); return; }
  queue.unshift({
    id: hit.id.videoId,
    title: hit.snippet.title,
    artist: hit.snippet.channelTitle.replace(/\s*-\s*Topic\s*$/i, '').trim()
  });
  saveQueue(); renderQueue(); playIdx(0); ui.artist.value = ''; ui.song.value = '';
};

/* === Init === */
loadQueue(); renderQueue(); refreshSel(); if (queue.length) playIdx(0);
  </script>
  <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
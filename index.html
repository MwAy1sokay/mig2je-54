<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mattmusikspelaresajt 1.42</title>

<link rel="icon" type="image/png" sizes="96x96"  href="/favicon-96x96.png">
<link rel="icon" type="image/svg+xml"           href="/favicon.svg">
<link rel="shortcut icon"                        href="/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180"     href="/apple-touch-icon.png">
<link rel="manifest"                             href="/site.webmanifest">
<link href="https://fonts.googleapis.com/css2?family=Overpass:wght@400;600&display=swap" rel="stylesheet">

<style>
/* ── THEME ─────────────────────────────────────────────────────── */
:root{
  --bg:#000;--panel:#111;--border:#333;--text:#fffcfc;
  --accent:#00877c;--accent-soft:#00cfbe;--gap:.65rem;
}

/* ── BASE LAYOUT ───────────────────────────────────────────────── */
*{box-sizing:border-box}
body{
  margin:0 auto;max-width:720px;padding:1.25rem;
  background:var(--bg);color:var(--text);
  font:400 1rem/1.45 "Overpass",Arial,Helvetica,sans-serif;
}
h1{margin:0 0 1.3rem;text-align:center;font-weight:600;letter-spacing:.03em}
a,button,input,select{font:inherit;color:inherit}

/* ── INPUTS & BUTTONS ─────────────────────────────────────────── */
input[type=text],input[type=range],select{
  background:var(--panel);border:1px solid var(--border);color:var(--text);
  border-radius:4px;
}
input[type=text],select{padding:.5rem .6rem}
button{
  padding:.5rem 1.35rem;border:none;border-radius:4px;cursor:pointer;
  background:var(--accent);color:#fff;transition:background .15s,transform .15s;
}
button:disabled{opacity:.35;cursor:default}
button:not(:disabled):hover{background:var(--accent-soft)}
button:not(:disabled):active{transform:scale(.97)}
:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

/* ── NOW PLAYING ──────────────────────────────────────────────── */
#nowPlaying{display:flex;align-items:center;gap:.75rem}
#nowTitle{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#nowTitle small{font-size:.9em;opacity:.7}

/* square artwork wrapper */
#videoWrap{position:relative;width:clamp(100px,28vw,100px);
  aspect-ratio:1/1;border-radius:6px;overflow:hidden;background:#000}
#player{position:absolute;width:1px;height:1px;opacity:0;pointer-events:none}
#art{width:100%;height:100%;object-fit:cover;object-position:center;
  border-radius:6px;opacity:0;transition:opacity .4s}
#art[src]{opacity:1}

/* buffering spinner */
#buffering{position:absolute;inset:0;display:none;place-content:center;
           backdrop-filter:blur(2px)}
#buffering::after{content:'';width:32px;height:32px;border:4px solid #fff3;
                  border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── CONTROLS ─────────────────────────────────────────────────── */
.controls{
  display:flex;align-items:center;gap:var(--gap);flex-wrap:wrap;
  margin:1.05rem 0 var(--gap)
}
.controls input[type=range]{flex:1 1 100%;margin-top:.45rem;height:7px;
  appearance:none;background:var(--border);border-radius:4px}
.controls input[type=range]::-webkit-slider-thumb{
  appearance:none;width:14px;height:14px;border-radius:50%;
  background:var(--accent);border:0;margin-top:-3.5px;cursor:pointer}
#time{min-width:5.5rem;text-align:center;font-variant-numeric:tabular-nums;opacity:.8}
@media(max-width:600px){
  #time{flex:1 1 100%;text-align:left;margin-top:.25rem}
  .controls button{width:48px;height:48px;padding:0;font-size:1.25rem;flex:0 0 auto}
}

/* ── SEARCH & MODE TOGGLE ─────────────────────────────────────── */
.search-bar{display:flex;flex-wrap:wrap;gap:var(--gap)}
.search-bar input{flex:1 1 12rem;width:auto}
.search-bar+.search-bar{margin-top:var(--gap)}
.search-mode{display:flex;gap:.8rem;align-items:center;font-size:.9rem;margin-top:.4rem}
.hidden{display:none}

/* ── QUEUE ─────────────────────────────────────────────────────── */
#queueWrap{max-height:50vh;overflow:auto;background:var(--panel);
           border:1px solid var(--border);border-radius:6px}
#queue li{display:flex;align-items:center;gap:.45rem;padding:.55rem .65rem;
          border-bottom:1px solid var(--border);transition:background .15s}
#queue li:last-child{border-bottom:none}
#queue li:hover{background:#181818}
#queue li span.title{flex:1;cursor:pointer;user-select:none}
#queue li img.thumb{width:48px;height:48px;flex:0 0 auto;object-fit:cover;
                    object-position:center;border-radius:4px}
.drag-handle{cursor:grab;font-size:1.1rem;padding:0 .25rem;opacity:.7}
li.sortable-chosen .drag-handle{cursor:grabbing;opacity:1}
#queue li button{padding:.25rem .7rem}

/* ── PLAYLIST PANEL ───────────────────────────────────────────── */
.playlist-controls{margin-top:1.8rem;padding:1rem;background:var(--panel);
  border:1px solid var(--border);border-radius:6px}
.playlist-controls h3{margin:0 0 .8rem;font-weight:600}
.playlist-controls button,label{margin-top:.5rem;margin-right:.7rem}
.playlist-controls input[type=file]{display:none}
</style>
</head>
<body>

<h1>Mattmusikspelaresajt 1.42</h1>

<!-- now playing -->
<div id="nowPlaying">
  <div id="videoWrap">
    <div id="player" allow="autoplay"></div>
    <img id="art" alt="">
    <div id="buffering" aria-hidden="true"></div>
  </div>
  <span id="nowTitle"></span>
</div>

<!-- controls -->
<div class="controls">
  <button id="prev" title="Previous">⏮</button>
  <button id="playPause" title="Play / Pause">▶</button>
  <button id="skip" title="Next">⏭</button>
  <span id="time">0:00 / 0:00</span>
  <input id="progress" type="range" min="0" max="100" value="0">
</div>

<!-- search -->
<div class="search-bar">
  <input id="artistInput" placeholder="Artist name">
  <input id="songInput"   placeholder="Song title">
  <button id="searchBtn">Search & Play</button>
</div>
<div class="search-mode">
  <label><input type="radio" name="mode" value="artist" checked>Artist + Title</label>
  <label><input type="radio" name="mode" value="code">Paste ID</label>
</div>

<h2>Music Queue</h2>
<div id="queueWrap"><ul id="queue"></ul></div>

<!-- playlists -->
<div class="playlist-controls">
  <h3>Playlists</h3>
  <input id="playlistName" placeholder="New playlist name">
  <button id="savePlaylist">Save Playlist</button><br><br>
  <select id="playlistSelect"><option value="">— Load playlist —</option></select>
  <button id="deletePlaylist">Delete</button><br><br>
  <button id="exportPlaylist">Export</button>
  <label>Import <input id="importFile" type="file" accept=".json"></label>
</div>

<!-- ── SCRIPTS ─────────────────────────────────────────────────── -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// ── DOM cache ────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const ui = {
  artist    : $('artistInput'),
  song      : $('songInput'),
  modeRadios: document.querySelectorAll('input[name="mode"]'),
  queueUL   : $('queue'),
  nowBox    : $('nowPlaying'),
  nowT      : $('nowTitle'),
  art       : $('art'),
  buffering : $('buffering'),
  playerBox : $('player'),
  playBtn   : $('playPause'),
  prevBtn   : $('prev'),
  skipBtn   : $('skip'),
  timeLbl   : $('time'),
  slider    : $('progress'),
  listSel   : $('playlistSelect'),
  importFile: $('importFile')
};

// ── helpers ------------------------------------------------------
const sec = s => { const m=Math.floor(s/60);return m+':'+String(Math.floor(s%60)).padStart(2,'0'); };
const ytThumb = (id,size='mqdefault') => `https://i.ytimg.com/vi/${encodeURIComponent(id)}/${size}.jpg`;

// ── state --------------------------------------------------------
let queue=[],currentIdx=-1,player,playerReady=false,pendingPlay=null,vidDur=0;

// ── persistent storage ------------------------------------------
const loadQueue = () => { queue = JSON.parse(localStorage.getItem('queue')||'[]'); };
const saveQueue = () => localStorage.setItem('queue',JSON.stringify(queue));

// ── mode toggle --------------------------------------------------
ui.modeRadios.forEach(r=>r.addEventListener('change',()=>{
  const code = document.querySelector('input[name="mode"]:checked').value==='code';
  ui.artist.classList.toggle('hidden',code);
  ui.song.placeholder = code?'YouTube video ID':'Song title';
}));

// ── YouTube iframe ----------------------------------------------
function onYouTubeIframeAPIReady(){
  player = new YT.Player(ui.playerBox,{height:225,width:400,
    playerVars:{controls:0,playsinline:1},
    events:{
      onReady:  ()=>{playerReady=true; if(pendingPlay!==null){playIdx(pendingPlay);pendingPlay=null;}},
      onStateChange:e=>{
        if(e.data===0) skip();          // ended
        ui.playBtn.textContent = e.data===1?'⏸':'▶';
        ui.buffering.style.display = e.data===3?'grid':'none';
      }
    }});
}

// ── queue rendering ---------------------------------------------
const renderQueue = () => {
  ui.queueUL.innerHTML='';
  queue.forEach((it,i)=>ui.queueUL.insertAdjacentHTML('beforeend',`
    <li data-id="${it.id}">
      <span class="drag-handle" aria-hidden="true">≡</span>
      <img class="thumb" src="${ytThumb(it.id)}" alt="">
      <span class="title">${it.title}<small>${it.artist?' — '+it.artist:''}</small></span>
      <button data-del="${i}">✕</button>
    </li>`));
};

// ── playback helpers --------------------------------------------
function updateNow(it){
  if(!it){ui.nowBox.style.display='none';return;}
  ui.art.src = ytThumb(it.id);
  ui.nowT.innerHTML = it.title + (it.artist?` <small>— ${it.artist}</small>`:'');
  ui.nowBox.style.display='flex';
}
function playIdx(i){
  if(!queue.length||i<0||i>=queue.length)return;
  if(!playerReady){pendingPlay=i;updateNow(queue[i]);return;}
  currentIdx=i;player.loadVideoById(queue[i].id);updateNow(queue[i]);
  vidDur=0;ui.timeLbl.textContent='0:00 / …';waitDur();
}
const skip = () => playIdx((currentIdx+1)%queue.length);
const waitDur = ()=>{
  const probe=setInterval(()=>{const d=player.getDuration();if(d){
    vidDur=d;ui.timeLbl.textContent='0:00 / '+sec(d);clearInterval(probe);
  }},200); setTimeout(()=>clearInterval(probe),4000);
};

// ── controls listeners ------------------------------------------
ui.playBtn.onclick = () => playerReady && (player.getPlayerState()===1?player.pauseVideo():player.playVideo());
ui.prevBtn.onclick = () => queue.length && playIdx((currentIdx-1+queue.length)%queue.length);
ui.skipBtn.onclick = skip;

ui.slider.oninput = e=>{
  if(!playerReady||!vidDur)return;
  const t=vidDur*e.target.value/100;player.seekTo(t,true);
  ui.timeLbl.textContent = sec(t)+' / '+sec(vidDur);
};

// ── timer update every second -----------------------------------
setInterval(()=>{
  if(!playerReady||!player.getDuration)return;
  if(!vidDur) vidDur = player.getDuration();
  if(!vidDur) return;
  const cur=player.getCurrentTime();
  ui.slider.value = cur/vidDur*100;
  ui.timeLbl.textContent = sec(cur)+' / '+sec(vidDur);
},1000);

// ── Sortable for drag-reorder -----------------------------------
new Sortable(ui.queueUL,{
  handle:'.drag-handle',animation:150,
  onEnd:e=>{queue.splice(e.newIndex,0,queue.splice(e.oldIndex,1)[0]);saveQueue();}
});

// ── queue click actions (play / delete) -------------------------
ui.queueUL.addEventListener('click',e=>{
  const idx=(e.target.dataset.del);
  if(idx!==undefined){queue.splice(idx,1);saveQueue();renderQueue();return;}
  if(e.target.closest('.title')) playIdx([...ui.queueUL.children].indexOf(e.target.closest('li')));
});

// ── right-click open on YouTube ---------------------------------
ui.queueUL.addEventListener('contextmenu',e=>{
  const li=e.target.closest('li[data-id]');if(!li)return;
  e.preventDefault();window.open('https://youtu.be/'+li.dataset.id,'_blank');
});

// ── search button ----------------------------------------------
document.getElementById('searchBtn').onclick = async ()=>{
  const mode=document.querySelector('input[name="mode"]:checked').value;
  if(mode==='code'){                        // paste-ID mode
    const id=ui.song.value.trim();if(!id)return alert('Paste a YouTube ID');
    const info=await fetchVideoInfo(id);
    queue.unshift({id,title:info.title,artist:info.artist});saveQueue();renderQueue();playIdx(0);
    ui.song.value='';return;
  }
  const artist=ui.artist.value.trim(),song=ui.song.value.trim();
  if(!artist||!song)return alert('Type both artist and song');
  const hit=await fetch(`https://noembed.com/embed?url=https://youtube.com/watch?v=search`)
  /* your existing searchOfficialAudio(...) can be reused here */
};

// ── boot --------------------------------------------------------
loadQueue();renderQueue();
</script>
<script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
